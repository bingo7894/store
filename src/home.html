<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SE-ED Bookstore</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <style>
      body {
        font-family: "Kanit", sans-serif;
      }
      .carousel-item img {
        max-height: 300px;
        object-fit: contain;
        width: 100%;
      }
      @media (min-width: 992px) {
        .carousel-item img {
          max-height: 400px;
        }
      }
      .product-scroll {
        overflow-x: auto;
        scrollbar-width: none; /* For Firefox */
      }
      .product-scroll::-webkit-scrollbar {
        display: none; /* For Chrome, Safari, and Opera */
      }
      .card-img-top {
        aspect-ratio: 2 / 3;
        object-fit: cover;
      }
    </style>
  </head>

  <body class="bg-light">
    <nav
      class="navbar navbar-expand-lg navbar-dark sticky-top"
      style="background-color: #e67e22 !important"
    >
      <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center fw-bold" href="/home">
          <img
            src="https://www.se-ed.com/content/images/logo-seed.png"
            alt="SE-ED"
            width="45"
            height="45"
            class="me-2"
          />
          SE-ED
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarMain"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarMain">
          <form class="mx-auto my-3 my-lg-0 col-lg-5 d-flex" role="search">
            <input
              class="form-control me-2"
              type="search"
              placeholder="ค้นหาหนังสือ ผู้แต่ง หรือสำนักพิมพ์..."
            />
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-search"></i>
            </button>
          </form>

          <ul class="navbar-nav ms-auto align-items-lg-center">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="bi bi-grid"></i> หมวดหมู่
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#"
                    ><i class="bi bi-book me-2"></i>หนังสือทั่วไป</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#"
                    ><i class="bi bi-mortarboard me-2"></i>หนังสือเรียน</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#"
                    ><i class="bi bi-journal-text me-2"></i>นิยาย</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#"
                    ><i class="bi bi-palette me-2"></i>อุปกรณ์สำนักงาน</a
                  >
                </li>
              </ul>
            </li>
            <li class="nav-item d-none" id="wishlist-link">
              <a class="nav-link" href="#"
                ><i class="bi bi-heart"></i> รายการโปรด</a
              >
            </li>
            <li class="nav-item position-relative d-none" id="cart-link">
              <a
                class="nav-link"
                href="#"
                data-bs-toggle="modal"
                data-bs-target="#cartModal"
                onclick="loadCartItems()"
              >
                <i class="bi bi-bag"></i> ตะกร้า
                <span
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                  id="cart-count-badge"
                  >0</span
                >
              </a>
            </li>
            <li class="nav-item ms-lg-2" id="auth-container">
              <a class="btn btn-light" href="/index.html"
                ><i class="bi bi-person"></i> เข้าสู่ระบบ</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid px-4">
        <div class="navbar-nav flex-row flex-wrap justify-content-center w-100">
          <a class="nav-link text-white fw-semibold px-3" href="#">ขายดี</a>
          <a class="nav-link text-white fw-semibold px-3" href="#">มาใหม่</a>
          <a class="nav-link text-white fw-semibold px-3" href="#">โปรโมชั่น</a>
          <a class="nav-link text-white fw-semibold px-3" href="#">นิยาย</a>
          <a class="nav-link text-white fw-semibold px-3" href="#">การศึกษา</a>
          <a class="nav-link text-white fw-semibold px-3" href="#"
            >เด็กและเยาวชน</a
          >
          <a class="nav-link text-white fw-semibold px-3" href="#">ธุรกิจ</a>
          <a class="nav-link text-white fw-semibold px-3" href="#">ศิลปะ</a>
          <a class="nav-link text-white fw-semibold px-3" href="#">อาหาร</a>
          <a class="nav-link text-white fw-semibold px-3" href="#">อุปกรณ์</a>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <h2 class="mb-4 fw-bold">โปรโมชั่นและสินค้าแนะนำ</h2>
      <div
        id="bannerCarousel"
        class="carousel slide carousel-fade mb-5"
        data-bs-ride="carousel"
      >
        <div class="carousel-indicators">
          <button
            type="button"
            data-bs-target="#bannerCarousel"
            data-bs-slide-to="0"
            class="active"
            aria-current="true"
          ></button>
          <button
            type="button"
            data-bs-target="#bannerCarousel"
            data-bs-slide-to="1"
          ></button>
          <button
            type="button"
            data-bs-target="#bannerCarousel"
            data-bs-slide-to="2"
          ></button>
        </div>
        <div class="carousel-inner rounded shadow-sm">
          <div class="carousel-item active">
            <img
              src="https://mp-static.se-ed.com/admin/web-management/hero-banner/lt7tfwnquwme2uihhjy0/gnzzn8kanlftork1414z"
              class="d-block w-100"
              alt="Banner 1"
            />
          </div>
          <div class="carousel-item">
            <img
              src="https://mp-static.se-ed.com/admin/web-management/hero-banner/qxahihduaii3x8cpxt99/8vosi43e9hvjo5o25byq"
              class="d-block w-100"
              alt="Banner 2"
            />
          </div>
          <div class="carousel-item">
            <img
              src="https://mp-static.se-ed.com/admin/web-management/hero-banner/bevy75ux4o8s23jcsp6o/oox083yhbwhzr7cf9zkq"
              class="d-block w-100"
              alt="Banner 3"
            />
          </div>
        </div>
        <button
          class="carousel-control-prev"
          type="button"
          data-bs-target="#bannerCarousel"
          data-bs-slide="prev"
        >
          <span class="carousel-control-prev-icon"></span>
        </button>
        <button
          class="carousel-control-next"
          type="button"
          data-bs-target="#bannerCarousel"
          data-bs-slide="next"
        >
          <span class="carousel-control-next-icon"></span>
        </button>
      </div>

      <div class="row mt-5 g-3 text-center">
        <div class="col-sm-6 col-md-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body p-2">
              <i class="bi bi-lightning-charge-fill display-6 text-primary"></i>
              <h5 class="mt-2 fs-6">จัดส่งเร็ว</h5>
              <p class="text-muted small">ส่งถึงบ้านภายใน 2-3 วัน</p>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-md-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body p-2">
              <i class="bi bi-shield-check display-6 text-primary"></i>
              <h5 class="mt-2 fs-6">ของแท้ 100%</h5>
              <p class="text-muted small">รับประกันสินค้าทุกชิ้น</p>
            </div>
          </div>
        </div>
        <div class="col-sm-12 col-md-4">
          <div class="card h-100 shadow-sm">
            <div class="card-body p-2">
              <i class="bi bi-arrow-repeat display-6 text-primary"></i>
              <h5 class="mt-2 fs-6">เปลี่ยนคืนง่าย</h5>
              <p class="text-muted small">เปลี่ยนหรือคืนสินค้าได้ใน 7 วัน</p>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="fw-bold fs-4">สินค้าแนะนำ</h2>
          <a href="#" class="text-danger text-decoration-none fw-semibold"
            >ดูทั้งหมด <i class="bi bi-arrow-right"></i
          ></a>
        </div>
        <div class="product-scroll">
          <div class="d-flex flex-nowrap pb-3" id="productList"></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="cartModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-cart3 me-2"></i>ตะกร้าสินค้าของคุณ
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body" id="cart-items-container"></div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ปิด
            </button>
            <a href="/checkout" class="btn btn-primary">ชำระเงิน</a>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>

    <script>
      /**
       * [ปลอดภัย] สร้างการ์ดสินค้าโดยใช้ DOM Elements
       * @param {object} product - อ็อบเจกต์ข้อมูลสินค้า
       * @param {boolean} isLoggedIn - สถานะการล็อกอินของผู้ใช้
       * @returns {HTMLElement} - Element ของการ์ดสินค้าที่สร้างเสร็จ
       */
      function createProductCardElement(product, isLoggedIn) {
        const card = document.createElement("div");
        card.className = "card h-100 border-0 shadow-sm";

        const link = document.createElement("a");
        link.href = `/product.html?id=${product.id}`;
        link.className = "text-decoration-none";

        const img = document.createElement("img");
        img.src = product.image_url;
        img.className = "card-img-top";
        img.alt = product.name;
        img.onerror = () => {
          img.onerror = null;
          img.src = "https://via.placeholder.com/200x300?text=No+Image";
        };
        link.appendChild(img);

        const cardBody = document.createElement("div");
        cardBody.className = "card-body p-2 d-flex flex-column";

        const title = document.createElement("h6");
        title.className = "card-title";
        title.style.fontSize = "0.9em";
        title.style.minHeight = "40px";
        const titleLink = document.createElement("a");
        titleLink.href = `/product.html?id=${product.id}`;
        titleLink.className = "text-dark text-decoration-none";
        titleLink.textContent = product.name; // <-- ปลอดภัย
        title.appendChild(titleLink);

        const type = document.createElement("p");
        type.className = "card-text small text-muted mt-auto";
        type.textContent = product.type; // <-- ปลอดภัย

        const priceContainer = document.createElement("div");
        priceContainer.className = "mb-2";
        const priceSpan = document.createElement("span");
        priceSpan.className = "text-danger fw-bold";
        priceSpan.textContent = `฿ ${product.price}`; // <-- ปลอดภัย
        priceContainer.appendChild(priceSpan);

        if (product.old_price) {
          const oldPriceSpan = document.createElement("span");
          oldPriceSpan.className =
            "text-muted text-decoration-line-through small ms-1";
          oldPriceSpan.textContent = `฿ ${product.old_price}`; // <-- ปลอดภัย
          priceContainer.appendChild(oldPriceSpan);
        }

        cardBody.appendChild(title);
        cardBody.appendChild(type);
        cardBody.appendChild(priceContainer);

        if (isLoggedIn) {
          const cartButton = document.createElement("button");
          cartButton.className = "btn btn-sm btn-primary w-100";
          cartButton.innerHTML =
            '<i class="bi bi-cart-plus me-1"></i> ใส่ตะกร้า'; // HTML ปลอดภัยเพราะเราเขียนเอง
          cartButton.addEventListener("click", () =>
            addToCart(product.id, product.name)
          ); // <-- ปลอดภัย
          cardBody.appendChild(cartButton);
        } else {
          const loginButton = document.createElement("a");
          loginButton.href = "/index.html";
          loginButton.className = "btn btn-sm btn-outline-secondary w-100";
          loginButton.textContent = "เข้าสู่ระบบเพื่อซื้อ";
          cardBody.appendChild(loginButton);
        }

        card.appendChild(link);
        card.appendChild(cardBody);
        return card;
      }

      /**
       * [ปลอดภัย] สร้างแถวแสดงสินค้า 1 รายการในตะกร้าโดยใช้ DOM Elements
       * @param {object} item - อ็อบเจกต์ข้อมูลสินค้าในตะกร้า
       * @returns {HTMLElement} - Element ของแถวสินค้า
       */
      function createCartItemElement(item) {
        const itemTotal = (item.price * item.quantity).toFixed(2);

        const wrapper = document.createElement("div");
        wrapper.className =
          "d-flex align-items-center justify-content-between mb-3";

        const img = document.createElement("img");
        img.src = item.image_url;
        img.width = 60;
        img.className = "rounded me-3";

        const infoDiv = document.createElement("div");
        infoDiv.className = "flex-grow-1";
        const nameH6 = document.createElement("h6");
        nameH6.className = "mb-0 small";
        nameH6.textContent = item.name; // <-- ปลอดภัย
        const priceSpan = document.createElement("span");
        priceSpan.className = "text-muted small";
        priceSpan.textContent = `฿${item.price}`; // <-- ปลอดภัย
        infoDiv.append(nameH6, priceSpan);

        const controlGroup = document.createElement("div");
        controlGroup.className = "input-group w-auto";
        controlGroup.style.maxWidth = "120px";
        const btnMinus = document.createElement("button");
        btnMinus.className = "btn btn-outline-secondary btn-sm";
        btnMinus.textContent = "-";
        btnMinus.addEventListener("click", () =>
          updateCartQuantity(item.product_id, item.quantity - 1)
        ); // <-- ปลอดภัย
        const inputQty = document.createElement("input");
        inputQty.type = "text";
        inputQty.className = "form-control form-control-sm text-center";
        inputQty.value = item.quantity; // <-- ปลอดภัย (value ไม่ถูก execute)
        inputQty.readOnly = true;
        const btnPlus = document.createElement("button");
        btnPlus.className = "btn btn-outline-secondary btn-sm";
        btnPlus.textContent = "+";
        btnPlus.addEventListener("click", () =>
          updateCartQuantity(item.product_id, item.quantity + 1)
        ); // <-- ปลอดภัย
        controlGroup.append(btnMinus, inputQty, btnPlus);

        const totalSpan = document.createElement("span");
        totalSpan.className = "fw-bold mx-3";
        totalSpan.style.minWidth = "70px";
        totalSpan.style.textAlign = "right";
        totalSpan.textContent = `฿${itemTotal}`;

        const btnRemove = document.createElement("button");
        btnRemove.className = "btn btn-sm btn-outline-danger";
        btnRemove.innerHTML = '<i class="bi bi-trash"></i>';
        btnRemove.addEventListener("click", () =>
          removeFromCart(item.product_id)
        ); // <-- ปลอดภัย

        wrapper.append(img, infoDiv, controlGroup, totalSpan, btnRemove);
        return wrapper;
      }

      /** อัปเดตตัวเลขบนไอคอนตะกร้า */
      async function updateCartCount() {
        const badge = document.getElementById("cart-count-badge");
        if (!badge) return;
        try {
          const res = await axios.get("http://localhost:8000/api/cart", {
            withCredentials: true,
          });
          const totalQuantity = res.data.reduce(
            (sum, item) => sum + item.quantity,
            0
          );
          badge.textContent = totalQuantity; // <-- ปลอดภัย
        } catch (err) {
          badge.textContent = "0";
        }
      }

      /** เพิ่มสินค้าลงตะกร้า */
      async function addToCart(productId, productName) {
        try {
          await axios.post(
            "http://localhost:8000/api/cart",
            { productId, quantity: 1 },
            { withCredentials: true }
          );
          alert(`เพิ่ม "${productName}" ลงตะกร้าสำเร็จ!`);
          updateCartCount();
        } catch (err) {
          console.error("Add to cart error:", err);
          alert("เกิดข้อผิดพลาด: ไม่สามารถเพิ่มสินค้าลงตะกร้าได้");
        }
      }

      /** อัปเดตจำนวนสินค้าในตะกร้า */
      async function updateCartQuantity(productId, newQuantity) {
        if (newQuantity <= 0) {
          return removeFromCart(productId, false);
        }
        try {
          await axios.put(
            `http://localhost:8000/api/cart/${productId}`,
            { quantity: newQuantity },
            { withCredentials: true }
          );
          loadCartItems();
          updateCartCount();
        } catch (err) {
          console.error("Update quantity error:", err);
          alert("เกิดข้อผิดพลาดในการอัปเดตจำนวน");
        }
      }

      /** โหลดรายการสินค้าในตะกร้ามาแสดงใน Modal */
      async function loadCartItems() {
        const container = document.getElementById("cart-items-container");
        container.innerHTML =
          '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
        try {
          const res = await axios.get("http://localhost:8000/api/cart", {
            withCredentials: true,
          });
          const items = res.data;

          container.innerHTML = ""; // เคลียร์ container ก่อน

          if (items.length === 0) {
            container.innerHTML =
              '<p class="text-center text-muted">ยังไม่มีสินค้าในตะกร้า</p>';
            return;
          }

          items.forEach((item) => {
            container.appendChild(createCartItemElement(item));
          });

          const total = items.reduce(
            (sum, item) => sum + item.price * item.quantity,
            0
          );

          const hr = document.createElement("hr");
          const totalDiv = document.createElement("div");
          totalDiv.className = "d-flex justify-content-end fs-5";
          const totalLabel = document.createElement("span");
          totalLabel.className = "me-3";
          totalLabel.textContent = "ยอดรวม:";
          const totalValue = document.createElement("span");
          totalValue.className = "fw-bold text-danger";
          totalValue.textContent = `฿${total.toFixed(2)}`;
          totalDiv.append(totalLabel, totalValue);

          container.append(hr, totalDiv);
        } catch (err) {
          container.innerHTML =
            '<p class="text-center text-danger">ไม่สามารถโหลดข้อมูลตะกร้าได้</p>';
        }
      }

      /** ลบสินค้าออกจากตะกร้า */
      async function removeFromCart(productId, confirmFirst = true) {
        if (confirmFirst && !confirm("ต้องการลบสินค้านี้ออกจากตะกร้า?")) {
          return;
        }
        try {
          await axios.delete(`http://localhost:8000/api/cart/${productId}`, {
            withCredentials: true,
          });
          loadCartItems();
          updateCartCount();
        } catch (err) {
          alert("เกิดข้อผิดพลาดในการลบสินค้า");
        }
      }

      /** โหลดสินค้ามาแสดงบนหน้าเว็บ */
      async function loadProducts(isLoggedIn) {
        const container = document.getElementById("productList");
        container.innerHTML =
          '<div class="text-center w-100"><div class="spinner-border text-primary" role="status"></div></div>';
        try {
          const res = await axios.get("http://localhost:8000/api/products");
          const products = res.data;

          container.innerHTML = "";
          if (products.length === 0) {
            container.innerHTML = `<p class="text-muted w-100 text-center">ไม่พบสินค้าในขณะนี้</p>`;
            return;
          }

          products.forEach((p) => {
            const productCol = document.createElement("div");
            productCol.className =
              "col-6 col-sm-4 col-md-3 col-lg-2 flex-shrink-0 px-2";
            productCol.appendChild(createProductCardElement(p, isLoggedIn));
            container.appendChild(productCol);
          });
        } catch (err) {
          console.error("Load products error:", err);
          container.innerHTML = `<div class="alert alert-danger w-100">เกิดข้อผิดพลาดในการโหลดข้อมูลสินค้า</div>`;
        }
      }

      /** ออกจากระบบ */
      const logout = async () => {
        try {
          await axios.post(
            "http://localhost:8000/api/logout",
            {},
            { withCredentials: true }
          );
          window.location.reload();
        } catch (err) {
          console.error(err);
          alert("Logout failed!");
        }
      };

      /** ตรวจสอบสถานะล็อกอินและอัปเดต UI */
      const checkAuthStatus = async () => {
        const authContainer = document.getElementById("auth-container");
        try {
          const res = await axios.get("http://localhost:8000/api/users/me", {
            withCredentials: true,
          });
          const userData = res.data;

          authContainer.innerHTML = ""; // เคลียร์ปุ่ม Login เดิม

          const dropdownDiv = document.createElement("div");
          dropdownDiv.className = "dropdown";

          const mainLink = document.createElement("a");
          mainLink.className = "btn btn-light dropdown-toggle";
          mainLink.href = "#";
          mainLink.setAttribute("role", "button");
          mainLink.setAttribute("data-bs-toggle", "dropdown");
          mainLink.innerHTML = '<i class="bi bi-person-fill"></i>'; // HTML ปลอดภัย
          mainLink.append(` ${userData.email}`); // <-- ปลอดภัย

          const dropdownMenu = document.createElement("ul");
          dropdownMenu.className = "dropdown-menu dropdown-menu-end";

          let menuItemsHTML = "";
          if (userData.role === "admin") {
            menuItemsHTML += `<li><a class="dropdown-item" href="/admin/books"><i class="bi bi-gear-fill me-2"></i>จัดการหลังร้าน</a></li><li><hr class="dropdown-divider"></li>`;
          }
          menuItemsHTML += `
        <li><a class="dropdown-item" href="/profile.html">โปรไฟล์</a></li>
        <li><a class="dropdown-item" href="/orders">รายการสั่งซื้อ</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><button class="dropdown-item" id="logout-button">ออกจากระบบ</button></li>
      `;
          dropdownMenu.innerHTML = menuItemsHTML; // HTML ปลอดภัยเพราะเราเขียนเอง

          dropdownDiv.append(mainLink, dropdownMenu);
          authContainer.appendChild(dropdownDiv);

          // เพิ่ม event listener ให้ปุ่ม logout
          document
            .getElementById("logout-button")
            .addEventListener("click", logout);

          document.getElementById("wishlist-link").classList.remove("d-none");
          document.getElementById("cart-link").classList.remove("d-none");

          updateCartCount();
          loadProducts(true);
        } catch (err) {
          console.log("User is not logged in.");
          loadProducts(false);
        }
      };

      document.addEventListener("DOMContentLoaded", checkAuthStatus);
    </script>
  </body>
</html>
