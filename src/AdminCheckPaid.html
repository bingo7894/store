<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - จัดการคำสั่งซื้อที่ชำระเงินแล้ว</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <div class="container my-5">
      <div
        class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2"
      >
        <div>
          <h1 class="text-primary mb-1">
            จัดการคำสั่งซื้อที่ชำระเงินแล้ว (Paid Orders)
          </h1>
          <p class="text-muted mb-0">
            แสดงรายการคำสั่งซื้อที่มีสถานะ **'paid'**
            เพื่อให้ผู้ดูแลระบบดำเนินการใส่รหัสพัสดุ
          </p>
        </div>
        <div>
          <a href="/admin/shipped" class="btn btn-info">
            <i class="bi bi-truck me-1"></i> ดูรายการจัดส่งแล้ว
          </a>
          <a href="/admin/books" class="btn btn-outline-secondary ms-2">
            <i class="bi bi-arrow-left me-1"></i> กลับหน้าจัดการ
          </a>
        </div>
      </div>

      <div id="loadingMessage" class="alert alert-info">
        <span
          class="spinner-border spinner-border-sm me-2"
          role="status"
          aria-hidden="true"
        ></span>
        กำลังโหลดรายการคำสั่งซื้อ...
      </div>
      <div
        id="errorMessage"
        class="alert alert-danger"
        style="display: none"
      ></div>

      <div class="table-responsive">
        <table
          id="ordersTable"
          class="table table-striped table-hover align-middle"
        >
          <thead class="table-dark">
            <tr>
              <th>ID คำสั่งซื้อ</th>
              <th>อีเมลลูกค้า</th>
              <th>ยอดรวม (บาท)</th>
              <th>วันที่สั่งซื้อ</th>
              <th>รหัสพัสดุ</th>
              <th>สถานะ</th>
              <th>ดำเนินการ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p
        id="noOrders"
        class="text-center text-secondary my-4"
        style="display: none"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          fill="currentColor"
          class="bi bi-box-seam me-2"
          viewBox="0 0 16 16"
        >
          <path
            d="M8.288 2.2a.75.75 0 0 1 .424 0l4.996 2.5a.75.75 0 0 1 .376.65v5.8a.75.75 0 0 1-.376.65l-4.996 2.5a.75.75 0 0 1-.424 0l-4.996-2.5A.75.75 0 0 1 2.5 11.15V5.35a.75.75 0 0 1 .376-.65zM7.747.88a1.75 1.75 0 0 0-1.494 0L.998 4.382A1.75 1.75 0 0 0 .125 5.85v5.3a1.75 1.75 0 0 0 .873 1.468l4.996 2.5a1.75 1.75 0 0 0 1.494 0l4.996-2.5a1.75 1.75 0 0 0 .873-1.468v-5.3a1.75 1.75 0 0 0-.873-1.468L9.24 8.288 8 9.53V13.5a.5.5 0 0 1-1 0V9.53l-1.24-.766L.873 5.85a.75.75 0 0 1-.373-.65V5.35a.75.75 0 0 1 .373-.65l5.006-2.5a.75.75 0 0 1 .38 0l4.996 2.5a.75.75 0 0 1 .373.65v5.3a.75.75 0 0 1-.373.65L8.288 2.2zM15 11.15V5.35a.75.75 0 0 0-.373-.65L9.63 2.2a.75.75 0 0 0-.424 0L4.21 4.7a.75.75 0 0 0-.373.65v5.8a.75.75 0 0 0 .373.65L7.79 13.5a.75.75 0 0 0 .424 0z"
          />
        </svg>
        ไม่มีคำสั่งซื้อที่ต้องดำเนินการในขณะนี้
      </p>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      const ordersTableBody = document.querySelector("#ordersTable tbody");
      const loadingMessage = document.getElementById("loadingMessage");
      const errorMessage = document.getElementById("errorMessage");
      const noOrdersMessage = document.getElementById("noOrders");

      async function fetchPaidOrders() {
        loadingMessage.style.display = "block";
        errorMessage.style.display = "none";
        ordersTableBody.innerHTML = "";
        noOrdersMessage.style.display = "none";

        try {
          // ใช้ credentials: 'include' เพื่อส่ง cookie ไปด้วย
          const response = await fetch("/api/admin/paid-orders", {
            credentials: "include",
          });
          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              throw new Error("Authorization failed. Please log in as Admin.");
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const orders = await response.json();

          loadingMessage.style.display = "none";

          if (orders.length === 0) {
            noOrdersMessage.style.display = "block";
            return;
          }

          orders.forEach((order) => {
            const row = ordersTableBody.insertRow();
            row.innerHTML = `
                          <td>${order.order_id}</td>
                          <td>${order.user_email}</td>
                          <td>${parseFloat(order.total_amount).toFixed(2)}</td>
                          <td>${new Date(order.created_at).toLocaleDateString(
                            "th-TH"
                          )}</td>
                          <td>
                              <div class="input-group">
                                  <input type="text" class="form-control tracking-input" name="trackingNumber" placeholder="กรอกรหัสพัสดุ" required>
                              </div>
                          </td>
                          <td><span class="badge bg-success" id="status-${
                            order.order_id
                          }">${order.status}</span></td>
                          <td>
                              <button type="button" class="btn btn-sm btn-primary ship-btn" data-order-id="${
                                order.order_id
                              }">
                                  บันทึก & จัดส่ง
                              </button>
                          </td>
                      `;
            row
              .querySelector(".ship-btn")
              .addEventListener("click", handleShipping);
          });
        } catch (error) {
          console.error("Error fetching orders:", error);
          loadingMessage.style.display = "none";
          errorMessage.textContent = `เกิดข้อผิดพลาดในการโหลดคำสั่งซื้อ: ${error.message}`;
          errorMessage.style.display = "block";
        }
      }

      async function handleShipping(event) {
        const shipButton = event.target;
        const orderId = shipButton.dataset.orderId;
        const row = shipButton.closest("tr");
        const trackingInput = row.querySelector(".tracking-input");
        const trackingNumber = trackingInput.value.trim();

        if (!trackingNumber) {
          alert("กรุณากรอกรหัสพัสดุก่อนบันทึก");
          trackingInput.focus();
          return;
        }

        const originalButtonText = shipButton.textContent;
        shipButton.disabled = true;
        shipButton.textContent = "กำลังบันทึก...";

        try {
          // แก้ไข URL จาก order เป็น orders
          const response = await fetch(
            `/api/admin/orders/${orderId}/tracking`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include", // ส่ง cookie ไปด้วย
              body: JSON.stringify({ trackingNumber }),
            }
          );

          if (!response.ok) {
            const result = await response.json(); // พยายามอ่าน error message จาก server
            throw new Error(
              result.message || `Failed to update. Status: ${response.status}`
            );
          }

          // ไม่จำเป็นต้อง .json() ถ้า server ตอบกลับมาแค่ status 200/204
          // const result = await response.json();

          alert(
            `✅ บันทึกรหัสพัสดุ ${trackingNumber} สำหรับ Order ID ${orderId} และเปลี่ยนสถานะเป็น 'shipped' เรียบร้อยแล้ว`
          );
          fetchPaidOrders(); // โหลดข้อมูลใหม่เพื่อลบรายการที่จัดส่งแล้วออกไป
        } catch (error) {
          console.error("Shipping update error:", error);
          alert(`❌ เกิดข้อผิดพลาด: ${error.message}`);
          shipButton.disabled = false;
          shipButton.textContent = originalButtonText;
        }
      }

      document.addEventListener("DOMContentLoaded", fetchPaidOrders);
    </script>
  </body>
</html>
