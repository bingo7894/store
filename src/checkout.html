<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <style>
      body {
        font-family: "Kanit", sans-serif;
        background-color: #f8f9fa;
      }
      #payment-element {
        margin-bottom: 24px;
      }
    </style>
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <div class="container my-5">
      <div class="row justify-content-center">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-body p-4">
              <h2 class="text-center mb-4">ชำระเงิน</h2>

              <div id="order-summary" class="mb-4"></div>

              <form id="payment-form">
                <div id="payment-element"></div>
                <button id="submit" class="btn btn-primary w-100 btn-lg">
                  <span id="button-text">ชำระเงิน</span>
                  <div
                    id="spinner"
                    class="spinner-border spinner-border-sm d-none"
                    role="status"
                  ></div>
                </button>
                <div
                  id="payment-message"
                  class="mt-2 text-danger text-center"
                ></div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 1. ใส่ Publishable Key ของคุณ
      const stripe = Stripe("pk_test_");

      let elements;

      // 2. เริ่มกระบวนการทั้งหมดโดยการตรวจสอบโปรไฟล์
      checkProfileAndInitialize();

      // --- ฟังก์ชันหลัก ---

      // ฟังก์ชันนี้จะทำงานเป็นอันดับแรก
      async function checkProfileAndInitialize() {
        try {
          const response = await fetch("/api/profile", {
            credentials: "include",
          });

          // ถ้ายังไม่ login ให้ไปหน้า login
          if (response.status === 401) {
            window.location.href = "/login.html";
            return;
          }

          const user = await response.json();

          // ตรวจสอบว่ามีข้อมูลครบหรือไม่
          if (
            !user.firstname ||
            !user.lastname ||
            !user.phone ||
            !user.address
          ) {
            alert(
              "กรุณากรอกข้อมูลส่วนตัว (ชื่อ, เบอร์โทร, ที่อยู่) ให้ครบถ้วนก่อนทำการสั่งซื้อ"
            );
            window.location.href = "/profile.html"; // ถ้าไม่ครบ ให้ไปหน้าโปรไฟล์
            return;
          }

          // ถ้าข้อมูลครบ...
          displayShippingAddress(user); // 1. แสดงที่อยู่สำหรับจัดส่ง
          initializeStripe(); // 2. เริ่มต้น Stripe
          displayOrderSummary(); // 3. โหลดสรุปรายการสินค้า
        } catch (err) {
          console.error("Profile check error:", err);
          showMessage("เกิดข้อผิดพลาดในการตรวจสอบข้อมูลส่วนตัว");
        }
      }

      // แสดงที่อยู่สำหรับจัดส่ง
      function displayShippingAddress(user) {
        const addressContainer = document.createElement("div");
        addressContainer.id = "shipping-address";
        addressContainer.className = "mb-4 p-3 border rounded bg-light";
        addressContainer.innerHTML = `
            <h5 class="mb-3"><i class="bi bi-geo-alt-fill me-2"></i>ที่อยู่สำหรับจัดส่ง</h5>
            <p class="mb-1"><strong>${user.firstname} ${user.lastname}</strong></p>
            <p class="mb-1">${user.address}</p>
            <p class="mb-0">โทร: ${user.phone}</p>
            <a href="/profile.html" class="btn btn-sm btn-outline-secondary mt-2">แก้ไขที่อยู่</a>
        `;
        // แทรกที่อยู่ก่อนฟอร์มจ่ายเงิน
        const paymentForm = document.getElementById("payment-form");
        paymentForm.parentNode.insertBefore(addressContainer, paymentForm);
      }

      // เริ่มต้น Stripe Payment Element
      async function initializeStripe() {
        try {
          const response = await fetch("/api/create-payment-intent", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
          });
          const { clientSecret } = await response.json();

          elements = stripe.elements({ clientSecret });

          const paymentElement = elements.create("payment");
          paymentElement.mount("#payment-element");

          document
            .querySelector("#payment-form")
            .addEventListener("submit", handleSubmit);
        } catch (err) {
          console.error("Stripe initialization error:", err);
          showMessage("ไม่สามารถเริ่มต้นกระบวนการชำระเงินได้");
        }
      }

      // โหลดสรุปรายการสินค้าจากตะกร้า
      async function displayOrderSummary() {
        const container = document.getElementById("order-summary");
        try {
          const response = await fetch("/api/cart/summary", {
            credentials: "include",
          }); // ใช้ API /summary
          if (!response.ok) throw new Error("Failed to fetch summary");

          const { items, total } = await response.json();

          if (items.length === 0) {
            container.innerHTML =
              '<div class="alert alert-info">ไม่มีสินค้าในตะกร้า</div>';
            document.getElementById("submit").disabled = true;
            return;
          }

          let itemsHtml = items
            .map(
              (item) => `
              <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>${item.name} <small class="text-muted">x ${
                item.quantity
              }</small></span>
                  <span class="fw-bold">฿${(item.price * item.quantity).toFixed(
                    2
                  )}</span>
              </li>
            `
            )
            .join("");

          container.innerHTML = `
              <h5>สรุปรายการสั่งซื้อ</h5>
              <ul class="list-group list-group-flush">
                  ${itemsHtml}
                  <li class="list-group-item d-flex justify-content-between fw-bold text-success fs-5">
                      <span>ยอดรวม</span>
                      <span>฿${total.toFixed(2)}</span>
                  </li>
              </ul>
          `;
        } catch (err) {
          container.innerHTML =
            '<div class="alert alert-warning">ไม่สามารถโหลดสรุปรายการได้</div>';
        }
      }

      // จัดการการชำระเงินเมื่อกดปุ่ม
      async function handleSubmit(e) {
        e.preventDefault();
        setLoading(true);

        const { error } = await stripe.confirmPayment({
          elements,
          confirmParams: {
            return_url: `${window.location.origin}/payment-success.html`,
          },
        });

        if (error.type === "card_error" || error.type === "validation_error") {
          showMessage(error.message);
        } else {
          showMessage("An unexpected error occurred.");
        }
        setLoading(false);
      }

      // --- Helper Functions ---
      function showMessage(messageText) {
        document.querySelector("#payment-message").textContent = messageText;
      }

      function setLoading(isLoading) {
        document.querySelector("#submit").disabled = isLoading;
        document
          .querySelector("#spinner")
          .classList.toggle("d-none", !isLoading);
        document
          .querySelector("#button-text")
          .classList.toggle("d-none", isLoading);
      }
    </script>
  </body>
</html>
