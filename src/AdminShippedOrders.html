<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <style>
      .tracking-input {
        border: none;
        background-color: transparent;
        font-weight: bold;
        padding: 0;
        width: 100%;
      }
      .tracking-input:disabled {
        color: #198754; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß */
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div class="container my-5">
      <h1 class="mb-4 text-primary border-bottom pb-2">
        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß üöö
      </h1>
      <p class="text-muted">
        ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
        <a
          href="/admin/check-paid"
          class="btn btn-sm btn-outline-secondary ms-3"
        >
          <i class="bi bi-arrow-left"></i> Paid Orders
        </a>
      </p>

      <div id="loadingMessage" class="alert alert-info" role="alert">
        <span
          class="spinner-border spinner-border-sm me-2"
          aria-hidden="true"
        ></span>
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...
      </div>
      <div
        id="errorMessage"
        class="alert alert-danger"
        style="display: none"
      ></div>

      <div class="table-responsive">
        <table
          id="shippedOrdersTable"
          class="table table-striped table-hover align-middle"
        >
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
              <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
              <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
              <th>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p
        id="noOrders"
        class="text-center text-secondary my-4"
        style="display: none"
      >
        <i class="bi bi-check-circle me-2"></i>
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
      </p>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      const ordersTableBody = document.querySelector(
        "#shippedOrdersTable tbody"
      );
      const loadingMessage = document.getElementById("loadingMessage");
      const errorMessage = document.getElementById("errorMessage");
      const noOrdersMessage = document.getElementById("noOrders");

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Tracking Number (‡πÉ‡∏ä‡πâ API ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)
      async function updateTrackingNumber(orderId, trackingNumber) {
        try {
          // *** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
          const updateRes = await fetch(
            `/api/admin/orders/${orderId}/tracking`, // <--- ‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å order ‡πÄ‡∏õ‡πá‡∏ô orders
            {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ trackingNumber }),
            }
          );

          if (!updateRes.ok) {
            const data = await updateRes.json();
            throw new Error(data.message || "Update failed");
          }

          alert(`‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Order #${orderId} ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);
        } catch (err) {
          console.error("API Update Error:", err);
          alert("Failed to update tracking number: " + err.message);
          throw err; // Re-throw error to revert changes on UI
        }
      }

      function renderOrders(orders) {
        ordersTableBody.innerHTML = "";

        if (orders.length === 0) {
          noOrdersMessage.style.display = "block";
          return;
        }

        orders.forEach((order) => {
          const initialTracking = order.tracking_number || "";
          const row = ordersTableBody.insertRow();

          row.innerHTML = `
                      <td><span class="fw-bold text-primary">#${
                        order.order_id
                      }</span></td>
                      <td>${order.user_email}</td>
                      <td>${Number(order.total_amount).toFixed(2)} ‡∏ö‡∏≤‡∏ó</td>
                      <td>${new Date(order.created_at).toLocaleDateString(
                        "th-TH",
                        { year: "numeric", month: "short", day: "numeric" }
                      )}</td>
                      <td>
                          <input type="text" class="form-control form-control-sm tracking-input text-success" value="${initialTracking}" disabled data-initial-value="${initialTracking}">
                      </td>
                      <td><span class="badge bg-primary text-uppercase">${
                        order.status
                      }</span></td>
                      <td>
                          <div class="action-buttons">
                              <button class="btn btn-sm btn-warning edit-btn"><i class="bi bi-pencil-fill"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                              <button class="btn btn-sm btn-success save-btn" style="display:none;"><i class="bi bi-save-fill"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                              <button class="btn btn-sm btn-danger cancel-btn" style="display:none;"><i class="bi bi-x-circle-fill"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                          </div>
                      </td>
                  `;

          const input = row.querySelector(".tracking-input");
          const editBtn = row.querySelector(".edit-btn");
          const saveBtn = row.querySelector(".save-btn");
          const cancelBtn = row.querySelector(".cancel-btn");

          // --- Event Listeners ---

          // 1. Edit Mode
          editBtn.addEventListener("click", () => {
            input.disabled = false;
            input.focus();
            editBtn.style.display = "none";
            saveBtn.style.display = "inline-block";
            cancelBtn.style.display = "inline-block";
            input.classList.add("border", "border-warning");
            input.classList.remove("text-success");
          });

          // 2. Cancel Mode
          cancelBtn.addEventListener("click", () => {
            input.value = input.dataset.initialValue;
            input.disabled = true;
            editBtn.style.display = "inline-block";
            saveBtn.style.display = "none";
            cancelBtn.style.display = "none";
            input.classList.remove("border", "border-warning");
            input.classList.add("text-success");
          });

          // 3. Save Mode
          saveBtn.addEventListener("click", async () => {
            const newTrackingNumber = input.value.trim();

            if (!newTrackingNumber) {
              alert("‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏");
              return;
            }

            if (newTrackingNumber === input.dataset.initialValue) {
              alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏´‡∏±‡∏™‡∏û‡∏±‡∏™‡∏î‡∏∏");
              cancelBtn.click();
              return;
            }

            try {
              await updateTrackingNumber(order.order_id, newTrackingNumber);
              input.dataset.initialValue = newTrackingNumber;
              cancelBtn.click();
            } catch (e) {
              // Error handling is inside updateTrackingNumber
            }
          });

          // 4. Enter key in input field
          input.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && !input.disabled) {
              saveBtn.click();
            }
          });
        });
      }

      async function loadShippedOrders() {
        loadingMessage.style.display = "block";
        errorMessage.style.display = "none";
        ordersTableBody.innerHTML = "";
        noOrdersMessage.style.display = "none";

        try {
          const response = await fetch("/api/admin/shipped-orders", {
            credentials: "include",
          });

          if (response.status === 401 || response.status === 403) {
            throw new Error("Authorization failed. Please log in as Admin.");
          }
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const orders = await response.json();
          loadingMessage.style.display = "none";

          renderOrders(orders);
        } catch (error) {
          console.error("Error fetching shipped orders:", error);
          loadingMessage.style.display = "none";
          errorMessage.textContent = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠: ${error.message}`;
          errorMessage.style.display = "block";
        }
      }

      document.addEventListener("DOMContentLoaded", loadShippedOrders);
    </script>
  </body>
</html>
